---
- name: Pull MariaDB image
  command: docker pull {{ mariadb_image }}
  register: pull_result
  changed_when: "'Downloaded' in pull_result.stdout"
  tags: [database]

- name: Check if container exists
  command: docker ps -a -q -f name={{ mariadb_container_name }}
  register: container_exists
  changed_when: false
  tags: [database]

- name: Create MariaDB container
  command: >
    docker run -d
    --name {{ mariadb_container_name }}
    --restart always
    --network host
    -e MYSQL_ROOT_PASSWORD={{ mariadb_root_password }}
    -e MYSQL_DATABASE={{ mariadb_database }}
    -e MYSQL_USER={{ mariadb_user }}
    -e MYSQL_PASSWORD={{ mariadb_password }}
    -v mariadb_data:/var/lib/mysql
    {{ mariadb_image }}
  when: container_exists.stdout == ""
  tags: [database]

- name: Ensure container is running
  command: docker start {{ mariadb_container_name }}
  changed_when: false
  failed_when: false
  tags: [database]

- name: Wait for MariaDB ready
  shell: docker exec {{ mariadb_container_name }} mariadb -u {{ mariadb_user }} -p{{ mariadb_password }} {{ mariadb_database }} -e "SELECT 1;"
  register: mysql_ready
  until: mysql_ready.rc == 0
  retries: 30
  delay: 2
  changed_when: false
  tags: [database]

- name: Open firewall (Debian)
  ufw:
    rule: allow
    port: "{{ mariadb_port }}"
    proto: tcp
  when: package_manager == "apt"
  failed_when: false
  tags: [database]

- name: Open firewall (Fedora)
  firewalld:
    port: "{{ mariadb_port }}/tcp"
    permanent: yes
    state: enabled
    immediate: yes
  when: package_manager == "dnf"
  failed_when: false
  tags: [database]

- name: Copy and execute SQL init script
  block:
    - name: Copy SQL script
      copy:
        src: init_db.sql
        dest: /tmp/init_db.sql
        mode: '0644'

    - name: Execute SQL script
      shell: docker exec -i {{ mariadb_container_name }} mariadb -u {{ mariadb_user }} -p{{ mariadb_password }} {{ mariadb_database }} < /tmp/init_db.sql
      failed_when: false

    - name: Cleanup
      file:
        path: /tmp/init_db.sql
        state: absent
  tags: [database]
